<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Sistema de Chamada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-dark: #0b0b0b;
            --card-bg: #1a1a1a;
            --accent-blue: #0d6efd;
            --accent-red: #ff4444;
            --accent-yellow: #ffca28;
        }

        body { background-color: var(--bg-dark); color: #ffffff; font-family: sans-serif; }
        .navbar { border-bottom: 2px solid var(--accent-yellow); }
        .card { background-color: var(--card-bg); border: 1px solid #333; }
        
        .table-dark-custom { --bs-table-bg: #1a1a1a; color: white; border-color: #333; }
        
        .status-presente { border-left: 4px solid var(--accent-blue); background: rgba(13, 110, 253, 0.1); }
        .status-ausente { border-left: 4px solid var(--accent-red); background: rgba(255, 68, 68, 0.1); color: var(--accent-red); }
        
        .text-yellow { color: var(--accent-yellow); }
        .btn-blue { background-color: var(--accent-blue); color: white; border: none; }
        .btn-blue:hover { background-color: #0b5ed7; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-black mb-4 p-3">
    <div class="container">
        <span class="navbar-brand fw-bold"><i class="bi bi-file-earmark-bar-graph text-yellow me-2"></i>RELATÓRIOS</span>
        <a href="index.html" class="btn btn-outline-light btn-sm">Voltar para Chamada</a>
    </div>
</nav>

<div class="container">
    <div class="row g-4">
        
        <div class="col-md-4">
            <div class="card p-3 shadow-lg">
                <h5 class="text-yellow mb-3">Pesquisa Individual</h5>
                <label class="small text-white-50">Selecione o Membro:</label>
                <select id="selectMembro" class="form-select bg-dark text-white border-secondary mb-3">
                    <option value="">Carregando membros...</option>
                </select>
                <button onclick="gerarRelatorioIndividual()" class="btn btn-blue w-100">
                    <i class="bi bi-search me-2"></i>Ver Histórico
                </button>
            </div>

            <div class="card p-3 shadow-lg mt-3">
                <h5 class="text-white mb-3">Resumo Geral</h5>
                <button onclick="gerarRelatorioGeral()" class="btn btn-outline-warning w-100 mb-2">
                    <i class="bi bi-people me-2"></i>Lista de Todos os Membros
                </button>
                <button onclick="window.print()" class="btn btn-outline-light w-100">
                    <i class="bi bi-printer me-2"></i>Imprimir PDF
                </button>
            </div>
        </div>

        <div class="col-md-8">
            <div id="areaRelatorio" class="card p-4 shadow-lg min-vh-50">
                <div id="placeholder" class="text-center py-5">
                    <i class="bi bi-clipboard-data text-white-50 fs-1"></i>
                    <p class="text-white-50 mt-2">Selecione um membro ou gere o relatório geral para visualizar os dados.</p>
                </div>
                
                <div id="conteudoRelatorio" class="d-none">
                    <h4 id="tituloRelatorio" class="text-white border-bottom pb-2 mb-3"></h4>
                    <div class="table-responsive">
                        <table class="table table-dark-custom align-middle" id="tabelaDados">
                            </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configurações do seu Firebase (Mesmas do index.html)
    const firebaseConfig = {
        apiKey: "AIzaSyCEMfA8_6LAbvanYwXE_6KcO0WQWoI5nSQ",
        authDomain: "chamada-membros.firebaseapp.com",
        projectId: "chamada-membros",
        storageBucket: "chamada-membros.firebasestorage.app",
        messagingSenderId: "787711011979",
        appId: "1:787711011979:web:0fa4c2efa8c4a2f2feb88e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Carregar lista de membros no Select (Ordem Alfabética)
    async function carregarMembros() {
        const select = document.getElementById('selectMembro');
        const q = query(collection(db, "membros"), orderBy("nome", "asc"));
        const snapshot = await getDocs(q);
        
        select.innerHTML = '<option value="">Selecione...</option>';
        snapshot.forEach(doc => {
            const m = doc.data();
            select.innerHTML += `<option value="${m.nome}">${m.nome}</option>`;
        });
    }

    // Gerar Relatório por Nome (Datas Presente/Ausente)
    window.gerarRelatorioIndividual = async () => {
        const nome = document.getElementById('selectMembro').value;
        if(!nome) return alert("Selecione um membro!");

        document.getElementById('placeholder').classList.add('d-none');
        const conteudo = document.getElementById('conteudoRelatorio');
        conteudo.classList.remove('d-none');
        
        document.getElementById('tituloRelatorio').innerHTML = `Histórico: <span class="text-yellow">${nome}</span>`;
        
        const q = query(collection(db, "presencas"), where("nome", "==", nome), orderBy("data", "desc"));
        const snapshot = await getDocs(q);
        
        let html = `<thead><tr><th>Data</th><th>Status</th></tr></thead><tbody>`;
        
        snapshot.forEach(doc => {
            const p = doc.data();
            const classe = p.status === 'Presente' ? 'status-presente' : 'status-ausente';
            html += `
                <tr class="${classe}">
                    <td>${formatarData(p.data)}</td>
                    <td class="fw-bold">${p.status.toUpperCase()}</td>
                </tr>`;
        });
        
        html += `</tbody>`;
        document.getElementById('tabelaDados').innerHTML = html;
    };

    // Gerar Relatório Geral (Todos os Membros)
    window.gerarRelatorioGeral = async () => {
        document.getElementById('placeholder').classList.add('d-none');
        document.getElementById('conteudoRelatorio').classList.remove('d-none');
        document.getElementById('tituloRelatorio').innerText = "Relatório Geral de Membros";

        const q = query(collection(db, "membros"), orderBy("nome", "asc"));
        const snapshot = await getDocs(q);
        
        let html = `<thead><tr><th>Nome</th><th>Funções</th></tr></thead><tbody>`;
        
        snapshot.forEach(doc => {
            const m = doc.data();
            html += `
                <tr>
                    <td class="text-white fw-bold">${m.nome}</td>
                    <td class="text-yellow small">${m.funcoes ? m.funcoes.join(', ') : 'Membro'}</td>
                </tr>`;
        });
        
        html += `</tbody>`;
        document.getElementById('tabelaDados').innerHTML = html;
    };

    function formatarData(dataStr) {
        const [ano, mes, dia] = dataStr.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    carregarMembros();
</script>

</body>
</html>