<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Detalhados - Maranata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #000000; color: #ffffff; padding-bottom: 80px; font-family: sans-serif; }
        .card-relatorio { background: #121212; border: 1px solid #333; border-radius: 12px; }
        
        .text-yellow { color: #ffca28 !important; }
        .text-blue { color: #0d6efd !important; }
        .text-red { color: #ff4444 !important; }

        .table { color: #ffffff !important; border-color: #333; }
        .table-dark { --bs-table-bg: #121212; }
        .td-nome { font-weight: bold; font-size: 0.9rem; }
        .td-funcao { color: #0d6efd; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .bg-presenca { background-color: rgba(13, 110, 253, 0.2); color: #0d6efd; border: 1px solid #0d6efd; }
        .bg-ausencia { background-color: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid #ff4444; }

        .navbar-custom { border-bottom: 2px solid #0d6efd; background-color: #000 !important; }

        /* --- ESTILO PARA DOWNLOAD/IMPRESSÃO --- */
        @media print {
            body { background-color: #ffffff !important; color: #000000 !important; }
            .navbar, .card-relatorio, .btn-download, a.btn { display: none !important; }
            .table { color: #000000 !important; width: 100% !important; }
            .table-dark { background-color: #fff !important; }
            .td-funcao { color: #555 !important; }
            .status-badge { border: 1px solid #000 !important; background: none !important; color: #000 !important; }
            #resultadoRelatorio { margin-top: 0 !important; }
            h6.text-yellow { color: #000 !important; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-black sticky-top navbar-custom p-3 shadow">
    <div class="container-fluid">
        <span class="navbar-brand fw-bold"><i class="bi bi-file-earmark-ruled text-primary me-2"></i>RELATÓRIOS</span>
        <div>
            <button onclick="window.print()" class="btn btn-success btn-sm me-2 btn-download">
                <i class="bi bi-download"></i> BAIXAR PDF
            </button>
            <a href="index.html" class="btn btn-outline-light btn-sm">Voltar</a>
        </div>
    </div>
</nav>

<div class="container mt-3">
    <div class="card card-relatorio p-3 mb-4 shadow">
        <div class="row g-2">
            <div class="col-12 mb-2">
                <label class="small text-white-50">Membro:</label>
                <select id="selectMembro" class="form-select bg-dark text-white border-secondary">
                    <option value="">Todos os Membros (Geral)</option>
                </select>
            </div>
            <div class="col-6">
                <label class="small text-white-50">Mês:</label>
                <select id="selectMes" class="form-select bg-dark text-white border-secondary">
                    <option value="">Todos</option>
                    <option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option>
                    <option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option>
                </select>
            </div>
            <div class="col-6">
                <label class="small text-white-50">Ano:</label>
                <select id="selectAno" class="form-select bg-dark text-white border-secondary">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                </select>
            </div>
        </div>
        <div class="d-flex gap-2 mt-3">
            <button id="btnIndividual" class="btn btn-primary flex-grow-1 fw-bold">INDIVIDUAL</button>
            <button id="btnGeral" class="btn btn-warning flex-grow-1 text-dark fw-bold">RELATÓRIO GERAL</button>
        </div>
    </div>

    <div id="resultadoRelatorio">
        <div id="listaHistorico" class="table-responsive"></div>
    </div>
</div>

<script type="module">
    // Mantenha seu script do Firebase exatamente como está
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEMfA8_6LAbvanYwXE_6KcO0WQWoI5nSQ",
        authDomain: "chamada-membros.firebaseapp.com",
        projectId: "chamada-membros",
        storageBucket: "chamada-membros.firebasestorage.app",
        messagingSenderId: "787711011979",
        appId: "1:787711011979:web:0fa4c2efa8c4a2f2feb88e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function formatarDataComDia(dataISO) {
        const diasSemana = ["Dom", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        const partes = dataISO.split('-');
        const dataObj = new Date(partes[0], partes[1] - 1, partes[2]);
        return `${diasSemana[dataObj.getDay()]}, ${partes[2]}/${partes[1]}`;
    }

    async function carregarMembros() {
        const q = query(collection(db, "membros"), orderBy("nome", "asc"));
        const snap = await getDocs(q);
        const select = document.getElementById('selectMembro');
        snap.forEach(doc => { select.innerHTML += `<option value="${doc.id}">${doc.id}</option>`; });
    }

    document.getElementById('btnIndividual').onclick = async () => {
        const nome = document.getElementById('selectMembro').value;
        const mes = document.getElementById('selectMes').value;
        const ano = document.getElementById('selectAno').value;
        if (!nome) return alert("Selecione um membro!");

        const listaDiv = document.getElementById('listaHistorico');
        listaDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';

        const membroDoc = await getDoc(doc(db, "membros", nome));
        const funcoes = membroDoc.data().funcoes ? membroDoc.data().funcoes.join(" • ") : "GERAL";

        const q = query(collection(db, "chamada_diaria"), where("nome", "==", nome), orderBy("data", "desc"));
        const snap = await getDocs(q);

        let html = `<div class="mb-3"><span class="td-nome d-block">${nome}</span><span class="td-funcao">${funcoes}</span></div>`;
        html += `<table class="table table-dark"><thead><tr><th>Data</th><th>Status</th></tr></thead><tbody>`;
        
        let temDados = false;
        snap.forEach(docSnap => {
            const p = docSnap.data();
            const [pAno, pMes] = p.data.split('-');
            if ((mes === "" || pMes === mes) && pAno === ano) {
                temDados = true;
                const isP = p.status === 'Presente';
                html += `<tr>
                    <td class="small">${formatarDataComDia(p.data)}</td>
                    <td><span class="status-badge ${isP ? 'bg-presenca' : 'bg-ausencia'}">${p.status.toUpperCase()}</span></td>
                </tr>`;
            }
        });
        if(!temDados) html += `<tr><td colspan="2" class="text-center text-white-50">Nenhum registro encontrado.</td></tr>`;
        listaDiv.innerHTML = html + "</tbody></table>";
    };

    document.getElementById('btnGeral').onclick = async () => {
        const mes = document.getElementById('selectMes').value;
        const ano = document.getElementById('selectAno').value;
        const listaDiv = document.getElementById('listaHistorico');
        listaDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning"></div></div>';

        const qPresencas = await getDocs(collection(db, "chamada_diaria"));
        const qMembros = await getDocs(collection(db, "membros"));

        let resumo = {};
        qPresencas.forEach(docSnap => {
            const p = docSnap.data();
            const [pAno, pMes] = p.data.split('-');
            if ((mes === "" || pMes === mes) && pAno === ano) {
                if (!resumo[p.nome]) resumo[p.nome] = { p: 0, f: 0 };
                p.status === 'Presente' ? resumo[p.nome].p++ : resumo[p.nome].f++;
            }
        });

        let html = `<h6 class="text-yellow mb-3">Resumo Geral: ${mes || 'Anual'} / ${ano}</h6>`;
        html += `<table class="table table-dark table-striped"><thead><tr><th>Nome / Função</th><th class="text-center">P</th><th class="text-center">F</th></tr></thead><tbody>`;

        qMembros.forEach(docSnap => {
            const m = docSnap.data();
            const d = resumo[m.nome] || { p: 0, f: 0 };
            const funs = m.funcoes ? m.funcoes.join(", ") : "---";
            html += `<tr>
                <td><div class="td-nome">${m.nome}</div><div class="td-funcao">${funs}</div></td>
                <td class="text-center text-blue fw-bold">${d.p}</td>
                <td class="text-center text-red fw-bold">${d.f}</td>
            </tr>`;
        });
        listaDiv.innerHTML = html + "</tbody></table>";
    };

    carregarMembros();
</script>
</body>
</html>