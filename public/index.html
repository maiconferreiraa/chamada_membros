<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chamada Maranata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-dark: #000000;
            --card-bg: #121212;
            --modal-claro: #2c2c2c;
            --primary-blue: #0d6efd;
            --danger-red: #ff4444;
            --warning-yellow: #ffca28;
            --text-white: #ffffff;
        }

        body { background-color: var(--bg-dark); color: var(--text-white); padding-bottom: 90px; font-family: sans-serif; }
        
        .header-data { background: #1a1a1a; padding: 15px; border-bottom: 2px solid var(--primary-blue); text-align: center; }
        .data-texto { font-size: 1.1rem; font-weight: bold; color: var(--warning-yellow); margin: 0; }

        #avisoChamadaFeita { display: none; }
        .alert-custom { background: rgba(255, 202, 40, 0.1); color: var(--warning-yellow); border: 1px solid var(--warning-yellow); font-size: 0.85rem; border-radius: 8px; }

        .nav-tabs { border-bottom: 1px solid #333; justify-content: center; background: #000; }
        .nav-link { color: #888 !important; border: none !important; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; padding: 12px 15px; }
        .nav-link.active { color: var(--primary-blue) !important; background: transparent !important; border-bottom: 3px solid var(--primary-blue) !important; }

        .modal-content { background-color: var(--modal-claro) !important; border: 2px solid var(--primary-blue) !important; border-radius: 15px !important; }
        .form-control-custom { color: #000 !important; background-color: #fff !important; border: 2px solid var(--primary-blue) !important; font-weight: bold; }

        .member-card { background-color: var(--card-bg); border: 1px solid #333; margin: 8px 12px; border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .member-info { flex: 1; margin-right: 5px; overflow: hidden; min-width: 0; }
        .member-name { font-size: 0.95rem; font-weight: bold; color: var(--text-white); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .tag-container { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; margin-top: 4px; }
        .badge-grupo { background-color: var(--warning-yellow); color: #000; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; text-transform: uppercase; }
        .badge-funcao { font-size: 0.6rem; color: var(--primary-blue); text-transform: uppercase; border: 1px solid var(--primary-blue); padding: 1px 4px; border-radius: 4px; font-weight: bold; }

        .btn-call { width: 40px; height: 38px; border: 1px solid #444; background: transparent; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-p { color: var(--primary-blue); border-color: var(--primary-blue); border-radius: 6px 0 0 6px; }
        .btn-f { color: var(--danger-red); border-color: var(--danger-red); border-radius: 0; }
        .btn-fj { color: var(--warning-yellow); border-color: var(--warning-yellow); border-radius: 0 6px 6px 0; }
        
        .btn-p.active { background-color: var(--primary-blue) !important; color: white !important; }
        .btn-f.active { background-color: var(--danger-red) !important; color: white !important; }
        .btn-fj.active { background-color: var(--warning-yellow) !important; color: black !important; }

        .btn-edit { color: #555; border: none; background: transparent; font-size: 1.1rem; margin-right: 5px; cursor: pointer; }
        .btn-float { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--primary-blue); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: none; z-index: 1000; }
        .navbar-custom { background-color: #000 !important; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div class="header-data">
    <p id="exibirData" class="data-texto"></p>
    <p class="small text-white-50 m-0">LISTA DE PRESENÇA - MEMBROS COM FUNÇÃO</p>
</div>

<div id="avisoChamadaFeita" class="container mt-2">
    <div class="alert alert-custom text-center shadow-sm">
        <i class="bi bi-info-circle-fill me-2"></i>
        A chamada de hoje já foi iniciada por <span id="nomeQuemIniciou" class="fw-bold text-white">...</span>
    </div>
</div>

<ul class="nav nav-tabs sticky-top">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#comFuncao">Com Função</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#semFuncao">Geral</button></li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade show active" id="comFuncao"><div id="listaComFuncao" class="mt-2"></div></div>
    <div class="tab-pane fade" id="semFuncao"><div id="listaSemFuncao" class="mt-2"></div></div>
</div>

<button class="btn-float shadow" data-bs-toggle="modal" data-bs-target="#modalNovoMembro"><i class="bi bi-person-plus-fill"></i></button>

<div class="modal fade" id="modalIdentificacao" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Identificação</h5>
            </div>
            <div class="modal-body text-center">
                <p class="small text-white-50">Seja o primeiro a iniciar a chamada hoje!</p>
                <input type="text" id="nomeOperador" class="form-control form-control-custom" placeholder="Seu Nome">
                <button id="btnSalvarIdentificacao" class="btn btn-primary w-100 mt-4 fw-bold">INICIAR CHAMADA</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoMembro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Novo Membro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="novoNomeMembro" class="form-control form-control-custom mb-3" placeholder="Nome Completo">
                <input type="text" id="novoGrupoMembro" class="form-control form-control-custom mb-3" placeholder="Grupo (Ex: GRUPO 1)">
                <button id="btnSalvarNovoMembro" class="btn btn-primary w-100 fw-bold">SALVAR NO BANCO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarMembro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning" id="editNomeMembro">Gerenciar Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="text-white-50 small mb-1">Mudar Grupo:</label>
                <div class="input-group mb-3">
                    <input type="text" id="inputMudarGrupo" class="form-control form-control-custom">
                    <button id="btnSalvarGrupo" class="btn btn-success btn-sm">SALVAR</button>
                </div>
                <label class="text-white-50 small mb-1">Add Função:</label>
                <div class="input-group mb-3">
                    <input type="text" id="inputNovaFuncao" class="form-control form-control-custom">
                    <button id="btnAddFuncao" class="btn btn-primary">ADD</button>
                </div>
                <div id="containerTagsFuncao" class="mb-3 d-flex flex-wrap"></div>
                <hr class="border-secondary">
                <button id="btnLimparChamadaDia" class="btn btn-outline-warning btn-sm w-100 mb-2">LIMPAR CHAMADA DE HOJE</button>
                <button id="btnExcluirMembro" class="btn btn-outline-danger btn-sm w-100">EXCLUIR DEFINITIVAMENTE</button>
            </div>
        </div>
    </div>
</div>

<nav class="navbar fixed-bottom navbar-custom py-2">
    <div class="container d-flex justify-content-around">
        <a href="index.html" class="text-primary text-center text-decoration-none"><i class="bi bi-people-fill fs-4 d-block"></i><span style="font-size: 0.7rem;">Chamada</span></a>
        <a href="relatorio.html" class="text-white-50 text-center text-decoration-none"><i class="bi bi-file-bar-graph fs-4 d-block"></i><span style="font-size: 0.7rem;">Relatórios</span></a>
    </div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, query, orderBy, getDocs, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEMfA8_6LAbvanYwXE_6KcO0WQWoI5nSQ",
        authDomain: "chamada-membros.firebaseapp.com",
        projectId: "chamada-membros",
        storageBucket: "chamada-membros.firebasestorage.app",
        messagingSenderId: "787711011979",
        appId: "1:787711011979:web:0fa4c2efa8c4a2f2feb88e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const hojeISO = new Date().toISOString().split('T')[0];
    const diasSemanas = ["Dom", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
    document.getElementById('exibirData').innerText = new Date().toLocaleDateString('pt-BR') + " - " + diasSemanas[new Date().getDay()];

    let meuNome = localStorage.getItem('usuario_maranata');
    let membroSendoEditado = "";

    // FUNÇÃO PARA PINTAR OS BOTÕES (RESISTENTE A ATUALIZAÇÃO)
    async function colorirBotoes() {
        const q = query(collection(db, "chamada_diaria"), where("data", "==", hojeISO));
        const snap = await getDocs(q);
        
        // Limpa tudo antes de pintar
        document.querySelectorAll('.btn-call').forEach(btn => btn.classList.remove('active'));
        
        snap.forEach(dDoc => {
            const d = dDoc.data();
            const container = document.getElementById(`group-${d.nome}`);
            if (container) {
                if (d.status === "Presente") container.querySelector('.btn-p').classList.add('active');
                if (d.status === "Ausente") container.querySelector('.btn-f').classList.add('active');
                if (d.status === "Justificada") container.querySelector('.btn-fj').classList.add('active');
            }
        });
    }

    // MONITORAMENTO DA CHAMADA E OPERADOR
    onSnapshot(query(collection(db, "chamada_diaria"), where("data", "==", hojeISO)), (snap) => {
        const avisoDiv = document.getElementById('avisoChamadaFeita');
        if (!snap.empty) {
            const operador = snap.docs[0].data().operador || "OUTRA PESSOA";
            document.getElementById('nomeQuemIniciou').innerText = operador;
            avisoDiv.style.display = 'block';
            
            const modalEl = document.getElementById('modalIdentificacao');
            const inst = bootstrap.Modal.getInstance(modalEl);
            if(inst) inst.hide();
        } else {
            avisoDiv.style.display = 'none';
            if (!meuNome) {
                const m = new bootstrap.Modal(document.getElementById('modalIdentificacao'));
                m.show();
            }
        }
        colorirBotoes();
    });

    document.getElementById('btnSalvarIdentificacao').onclick = () => {
        const nomeInput = document.getElementById('nomeOperador').value.trim().toUpperCase();
        if (nomeInput.length < 3) return alert("Digite seu nome.");
        localStorage.setItem('usuario_maranata', nomeInput);
        meuNome = nomeInput;
        bootstrap.Modal.getInstance(document.getElementById('modalIdentificacao')).hide();
    };

    // LISTA DE MEMBROS
    onSnapshot(query(collection(db, "membros"), orderBy("nome", "asc")), (membroSnapshot) => {
        const listaCom = document.getElementById('listaComFuncao');
        const listaSem = document.getElementById('listaSemFuncao');
        listaCom.innerHTML = ""; listaSem.innerHTML = "";

        membroSnapshot.forEach(docSnap => {
            const m = docSnap.data();
            const html = `
                <div class="member-card">
                    <button class="btn-edit" onclick="abrirEditor('${m.nome}')"><i class="bi bi-pencil-square"></i></button>
                    <div class="member-info">
                        <span class="member-name">${m.nome}</span>
                        <div class="tag-container">
                            ${m.grupo ? `<span class="badge-grupo">${m.grupo}</span>` : ''}
                            ${m.funcoes ? m.funcoes.map(f => `<span class="badge-funcao">${f}</span>`).join('') : ''}
                        </div>
                    </div>
                    <div class="d-flex" id="group-${m.nome}">
                        <button onclick="fazerChamada('${m.nome}', 'P')" class="btn-call btn-p">P</button>
                        <button onclick="fazerChamada('${m.nome}', 'F')" class="btn-call btn-f">F</button>
                        <button onclick="fazerChamada('${m.nome}', 'FJ')" class="btn-call btn-fj">FJ</button>
                    </div>
                </div>`;
            if(m.funcoes && m.funcoes.length > 0) listaCom.innerHTML += html;
            else listaSem.innerHTML += html;
        });
        
        // Após criar a lista, pinta os botões imediatamente
        colorirBotoes();
    });

    window.fazerChamada = async (nome, statusAbv) => {
        if (!meuNome) return;
        let statusFinal = statusAbv === 'P' ? "Presente" : (statusAbv === 'F' ? "Ausente" : "Justificada");
        await setDoc(doc(db, "chamada_diaria", `${hojeISO}_${nome}`), { 
            nome, data: hojeISO, status: statusFinal, operador: meuNome 
        });
    };

    window.abrirEditor = async (nome) => {
        membroSendoEditado = nome;
        document.getElementById('editNomeMembro').innerText = nome;
        const modal = new bootstrap.Modal(document.getElementById('modalEditarMembro'));
        const mSnap = await getDoc(doc(db, "membros", nome));
        if(mSnap.exists()) document.getElementById('inputMudarGrupo').value = mSnap.data().grupo || "";
        const tagsDiv = document.getElementById('containerTagsFuncao');
        tagsDiv.innerHTML = "";
        (mSnap.data().funcoes || []).forEach(f => {
            tagsDiv.innerHTML += `<span class="badge-funcao m-1">${f} <i class="bi bi-x-circle text-danger ms-1" style="cursor:pointer" onclick="removerFuncao('${f}')"></i></span>`;
        });
        modal.show();
    };

    document.getElementById('btnLimparChamadaDia').onclick = async () => {
        if(confirm(`Limpar chamada de hoje para ${membroSendoEditado}?`)) {
            await deleteDoc(doc(db, "chamada_diaria", `${hojeISO}_${membroSendoEditado}`));
            const q = query(collection(db, "chamada_diaria"), where("data", "==", hojeISO));
            const snap = await getDocs(q);
            if(snap.empty) { localStorage.removeItem('usuario_maranata'); meuNome = null; }
            bootstrap.Modal.getInstance(document.getElementById('modalEditarMembro')).hide();
        }
    };

    // Funções extras
    document.getElementById('btnSalvarGrupo').onclick = async () => { await updateDoc(doc(db, "membros", membroSendoEditado), { grupo: document.getElementById('inputMudarGrupo').value.toUpperCase() }); };
    document.getElementById('btnAddFuncao').onclick = async () => { const f = document.getElementById('inputNovaFuncao').value.toUpperCase(); if(f) await updateDoc(doc(db, "membros", membroSendoEditado), { funcoes: arrayUnion(f) }); document.getElementById('inputNovaFuncao').value = ""; };
    window.removerFuncao = async (f) => { await updateDoc(doc(db, "membros", membroSendoEditado), { funcoes: arrayRemove(f) }); };
    document.getElementById('btnSalvarNovoMembro').onclick = async () => { const n = document.getElementById('novoNomeMembro').value.toUpperCase(); const g = document.getElementById('novoGrupoMembro').value.toUpperCase(); if(n) await setDoc(doc(db, "membros", n), { nome: n, grupo: g, funcoes: [] }); bootstrap.Modal.getInstance(document.getElementById('modalNovoMembro')).hide(); };
    document.getElementById('btnExcluirMembro').onclick = async () => { if(confirm("Excluir?")) { await deleteDoc(doc(db, "membros", membroSendoEditado)); bootstrap.Modal.getInstance(document.getElementById('modalEditarMembro')).hide(); } };

</script>
</body>
</html>