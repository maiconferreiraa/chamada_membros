<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chamada Maranata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-dark: #000000;
            --card-bg: #121212;
            --primary-blue: #0d6efd;
            --danger-red: #ff4444;
            --accent-yellow: #ffca28;
            --text-white: #ffffff;
        }

        body { background-color: var(--bg-dark); color: var(--text-white); padding-bottom: 90px; font-family: sans-serif; }
        
        /* Cabeçalho de Data */
        .header-data { background: #1a1a1a; padding: 15px; border-bottom: 2px solid var(--primary-blue); text-align: center; }
        .data-texto { font-size: 1.1rem; font-weight: bold; color: var(--accent-yellow); margin: 0; }

        /* Estilo das Abas */
        .nav-tabs { border-bottom: 1px solid #333; justify-content: center; background: #000; }
        .nav-link { color: #888 !important; border: none !important; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; padding: 12px 20px; }
        .nav-link.active { color: var(--primary-blue) !important; background: transparent !important; border-bottom: 3px solid var(--primary-blue) !important; }

        /* Cards de Membro */
        .member-card { 
            background-color: var(--card-bg); 
            border: 1px solid #333; 
            margin: 8px 12px; 
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-info { flex: 1; margin-right: 10px; overflow: hidden; }
        .member-name { font-size: 0.95rem; font-weight: bold; color: var(--text-white); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .member-functions { font-size: 0.7rem; color: var(--primary-blue); text-transform: uppercase; display: block; margin-top: 2px; }
        .text-grupo { color: var(--accent-yellow); font-size: 0.85rem; font-weight: normal; }

        /* Botões Compactos */
        .btn-call { width: 45px; height: 38px; border: 1px solid #444; background: transparent; font-weight: bold; transition: 0.2s; }
        .btn-p { color: var(--primary-blue); border-color: var(--primary-blue); border-radius: 6px 0 0 6px; }
        .btn-f { color: var(--danger-red); border-color: var(--danger-red); border-radius: 0 6px 6px 0; }
        .btn-p.active { background: var(--primary-blue); color: white; }
        .btn-f.active { background: var(--danger-red); color: white; }

        /* Botão Editar */
        .btn-edit { color: #555; border: none; background: transparent; font-size: 1.1rem; margin-right: 8px; padding: 0; }

        /* Botão Flutuante ADD */
        .btn-float { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--primary-blue); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4); border: none; z-index: 1000; }

        /* Modais com Letra Branca */
        .modal-content { background-color: #121212; border: 1px solid var(--primary-blue); }
        .form-control-custom { color: #ffffff !important; background-color: #000 !important; border: 1px solid #444 !important; }
        .form-control-custom::placeholder { color: #ffffff; opacity: 0.7; }
        
        .tag-funcao { display: inline-flex; align-items: center; background: #222; color: #fff; padding: 5px 12px; border-radius: 20px; margin: 3px; font-size: 0.8rem; border: 1px solid #444; }

        .navbar-custom { background-color: #000 !important; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div class="header-data">
    <p id="exibirData" class="data-texto"></p>
    <p class="small text-white-50 m-0">LISTA DE PRESENÇA</p>
</div>

<ul class="nav nav-tabs sticky-top" id="tabChamada">
    <li class="nav-item">
        <button class="nav-link active" id="com-tab" data-bs-toggle="tab" data-bs-target="#comFuncao">Com Função</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="sem-tab" data-bs-toggle="tab" data-bs-target="#semFuncao">Geral (Sem Função)</button>
    </li>
</ul>

<div class="tab-content" id="conteudoAbas">
    <div class="tab-pane fade show active" id="comFuncao"><div id="listaComFuncao" class="mt-2"></div></div>
    <div class="tab-pane fade" id="semFuncao"><div id="listaSemFuncao" class="mt-2"></div></div>
</div>

<button class="btn-float shadow" data-bs-toggle="modal" data-bs-target="#modalNovoMembro">
    <i class="bi bi-person-plus-fill"></i>
</button>

<div class="modal fade" id="modalNovoMembro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-yellow">Cadastrar Novo Membro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="text-white small fw-bold mb-1">Nome Completo:</label>
                    <input type="text" id="novoNomeMembro" class="form-control form-control-custom" placeholder="Digite o nome completo">
                </div>
                <div class="mb-3">
                    <label class="text-white small fw-bold mb-1">Grupo (Ex: GRUPO 1):</label>
                    <input type="text" id="novoGrupoMembro" class="form-control form-control-custom" placeholder="EX: GRUPO 1">
                </div>
                <button id="btnSalvarNovoMembro" class="btn btn-primary w-100 fw-bold">SALVAR NO BANCO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarMembro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-yellow" id="editNomeMembro">Gerenciar Membro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="text-white-50 small mb-2">Funções Atuais:</label>
                <div id="containerTagsFuncao" class="mb-3 d-flex flex-wrap"></div>
                
                <div class="input-group mb-4">
                    <input type="text" id="inputNovaFuncao" class="form-control form-control-custom" placeholder="EX: SOM, OBREIRO...">
                    <button id="btnAddFuncao" class="btn btn-primary">ADD</button>
                </div>

                <hr class="border-secondary">
                
                <div class="p-2 border border-warning rounded mb-3">
                    <label class="text-warning small fw-bold d-block mb-2">Correção de Erro:</label>
                    <button id="btnLimparChamadaDia" class="btn btn-outline-warning btn-sm w-100">
                        <i class="bi bi-eraser-fill me-2"></i>LIMPAR CHAMADA DE HOJE
                    </button>
                </div>

                <div class="p-2 border border-danger rounded">
                    <label class="text-danger small fw-bold d-block mb-2">Zona de Perigo:</label>
                    <button id="btnExcluirMembro" class="btn btn-outline-danger btn-sm w-100">
                        <i class="bi bi-trash3-fill me-2"></i>EXCLUIR MEMBRO DEFINITIVAMENTE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="navbar fixed-bottom navbar-custom py-2">
    <div class="container d-flex justify-content-around">
        <a href="index.html" class="text-primary text-center text-decoration-none"><i class="bi bi-people-fill fs-4 d-block"></i><span style="font-size: 0.7rem;">Chamada</span></a>
        <a href="relatorio.html" class="text-white-50 text-center text-decoration-none"><i class="bi bi-file-bar-graph fs-4 d-block"></i><span style="font-size: 0.7rem;">Relatórios</span></a>
    </div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEMfA8_6LAbvanYwXE_6KcO0WQWoI5nSQ",
        authDomain: "chamada-membros.firebaseapp.com",
        projectId: "chamada-membros",
        storageBucket: "chamada-membros.firebasestorage.app",
        messagingSenderId: "787711011979",
        appId: "1:787711011979:web:0fa4c2efa8c4a2f2feb88e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const dias = ["Domingo", "Segunda-Feira", "Terça-Feira", "Quarta-Feira", "Quinta-Feira", "Sexta-Feira", "Sábado"];
    const hojeObj = new Date();
    const hojeISO = hojeObj.toISOString().split('T')[0];
    document.getElementById('exibirData').innerText = hojeObj.toLocaleDateString('pt-BR') + " - " + dias[hojeObj.getDay()];

    let membroSendoEditado = "";

    // 1. Cadastrar Novo Membro
    document.getElementById('btnSalvarNovoMembro').onclick = async () => {
        const nome = document.getElementById('novoNomeMembro').value.trim().toUpperCase();
        const grupo = document.getElementById('novoGrupoMembro').value.trim().toUpperCase() || "GERAL";
        if(!nome) return alert("O nome é obrigatório!");
        try {
            await setDoc(doc(db, "membros", nome), { nome, grupo, funcoes: [] });
            document.getElementById('novoNomeMembro').value = "";
            bootstrap.Modal.getInstance(document.getElementById('modalNovoMembro')).hide();
        } catch (e) { alert(e.message); }
    };

    // 2. Renderizar Listas em Tempo Real
    onSnapshot(query(collection(db, "membros"), orderBy("nome", "asc")), (snapshot) => {
        const listaCom = document.getElementById('listaComFuncao');
        const listaSem = document.getElementById('listaSemFuncao');
        listaCom.innerHTML = ""; listaSem.innerHTML = "";

        snapshot.forEach(docSnap => {
            const m = docSnap.data();
            const temFun = m.funcoes && m.funcoes.length > 0;
            const nomeExibicao = `${m.nome} <span class="text-grupo">(${m.grupo || 'GERAL'})</span>`;

            const html = `
                <div class="member-card">
                    <button class="btn-edit" onclick="abrirEditor('${m.nome}')"><i class="bi bi-pencil-square"></i></button>
                    <div class="member-info">
                        <span class="member-name">${nomeExibicao}</span>
                        <span class="member-functions">${temFun ? m.funcoes.join(' • ') : ''}</span>
                    </div>
                    <div class="btn-group" data-id="${m.nome}">
                        <button onclick="fazerChamada('${m.nome}', 'P')" class="btn-call btn-p">P</button>
                        <button onclick="fazerChamada('${m.nome}', 'F')" class="btn-call btn-f">F</button>
                    </div>
                </div>`;
            if(temFun) listaCom.innerHTML += html;
            else listaSem.innerHTML += html;
        });
    });

    // 3. Abrir Editor Individual
    window.abrirEditor = (nome) => {
        membroSendoEditado = nome;
        document.getElementById('editNomeMembro').innerText = nome;
        const modal = new bootstrap.Modal(document.getElementById('modalEditarMembro'));
        onSnapshot(doc(db, "membros", nome), (docSnap) => {
            if(!docSnap.exists()) return;
            const tagsDiv = document.getElementById('containerTagsFuncao');
            tagsDiv.innerHTML = "";
            (docSnap.data().funcoes || []).forEach(f => {
                tagsDiv.innerHTML += `<span class="tag-funcao">${f} <i class="bi bi-x-circle text-danger ms-2" style="cursor:pointer" onclick="removerFuncao('${f}')"></i></span>`;
            });
        });
        modal.show();
    };

    // 4. Funções de Adicionar/Remover Categoria
    document.getElementById('btnAddFuncao').onclick = async () => {
        const f = document.getElementById('inputNovaFuncao').value.trim().toUpperCase();
        if(!f) return;
        await updateDoc(doc(db, "membros", membroSendoEditado), { funcoes: arrayUnion(f) });
        document.getElementById('inputNovaFuncao').value = "";
    };

    window.removerFuncao = async (f) => {
        if(confirm(`Remover função ${f}?`)) {
            await updateDoc(doc(db, "membros", membroSendoEditado), { funcoes: arrayRemove(f) });
        }
    };

    // 5. LIMPAR CHAMADA DE HOJE (ESTORNO)
    document.getElementById('btnLimparChamadaDia').onclick = async () => {
        if(confirm(`Deseja limpar a marcação de hoje para ${membroSendoEditado}?`)) {
            try {
                await deleteDoc(doc(db, "chamada_diaria", `${hojeISO}_${membroSendoEditado}`));
                document.querySelectorAll(`[data-id="${membroSendoEditado}"]`).forEach(el => {
                    el.querySelector('.btn-p').classList.remove('active');
                    el.querySelector('.btn-f').classList.remove('active');
                });
                bootstrap.Modal.getInstance(document.getElementById('modalEditarMembro')).hide();
                alert("Marcação removida!");
            } catch (e) { alert(e.message); }
        }
    };

    // 6. EXCLUIR MEMBRO
    document.getElementById('btnExcluirMembro').onclick = async () => {
        if(confirm(`Excluir ${membroSendoEditado} definitivamente?`)) {
            try {
                await deleteDoc(doc(db, "membros", membroSendoEditado));
                bootstrap.Modal.getInstance(document.getElementById('modalEditarMembro')).hide();
                alert("Membro removido!");
            } catch (e) { alert(e.message); }
        }
    };

    // 7. Fazer Chamada
    window.fazerChamada = async (nome, status) => {
        try {
            await setDoc(doc(db, "chamada_diaria", `${hojeISO}_${nome}`), {
                nome: nome, data: hojeISO, status: status === 'P' ? 'Presente' : 'Ausente'
            });
            document.querySelectorAll(`[data-id="${nome}"]`).forEach(el => {
                el.querySelector('.btn-p').classList.toggle('active', status === 'P');
                el.querySelector('.btn-f').classList.toggle('active', status === 'F');
            });
        } catch (e) { console.error(e); }
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>